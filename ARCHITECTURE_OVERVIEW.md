# ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø©

## ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Interface (Next.js)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  User App    â”‚  â”‚ Pharmacy App â”‚  â”‚Admin Panel   â”‚      â”‚
â”‚  â”‚  (Patients)  â”‚  â”‚(Pharmacies)  â”‚  â”‚(Statistics)  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend Features                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚    PWA       â”‚  â”‚ Geolocation  â”‚  â”‚  Analytics   â”‚      â”‚
â”‚  â”‚(Offline)    â”‚  â”‚(50km Range)  â”‚  â”‚  Tracking    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API Layer (Next.js Routes)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  /api/prescriptions/nearby-pharmacies    (Distance)  â”‚   â”‚
â”‚  â”‚  /api/notifications/subscribe           (PWA)       â”‚   â”‚
â”‚  â”‚  /api/notifications/send                (PWA)       â”‚   â”‚
â”‚  â”‚  /api/analytics                        (Stats)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Backend Services (Supabase/Node.js)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Database    â”‚  â”‚   Auth       â”‚  â”‚   Storage    â”‚      â”‚
â”‚  â”‚  (Postgres)  â”‚  â”‚  (Supabase)  â”‚  â”‚  (Bucket)    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### 1ï¸âƒ£ Ù…Ø³Ø§Ø± Ø±ÙØ¹ Ø§Ù„ÙˆØµÙØ© (User)

```
Patient Upload Prescription
         â†“
   [/app/upload]
         â†“
  Upload File + Photos
         â†“
  Save to Database
         â†“
  Trigger Event: prescription_upload
         â†“
  Log to analytics_events
         â†“
  Redirect to /prescriptions
         â†“
  Show "Send to Nearby Pharmacies" button
```

### 2ï¸âƒ£ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©

```
Patient Clicks "Send to Nearby Pharmacies"
         â†“
  [/app/prescriptions/select-pharmacies]
         â†“
  Get User Location (Geolocation API)
         â†“
  Call /api/prescriptions/nearby-pharmacies
         â†“
  Calculate Distance (Haversine + 1.2x factor)
         â†“
  Filter: Only 50km radius
         â†“
  Display Pharmacies with Checkboxes
         â†“
  User Selects Pharmacies
         â†“
  Create prescription_responses
         â†“
  Send Notifications to Pharmacies
         â†“
  Track in Analytics
```

### 3ï¸âƒ£ Ù…Ø³Ø§Ø± Notifications

```
Pharmacy Receives New Prescription
         â†“
  Save prescription_response
         â†“
  Get User's Push Subscription
         â†“
  Prepare Notification Payload
         â†“
  Send via Web Push API
         â†“
  Service Worker Receives Push Event
         â†“
  Display Notification to User
         â†“
  User Clicks â†’ Opens App
```

### 4ï¸âƒ£ Ù…Ø³Ø§Ø± Analytics

```
Any User Action
         â†“
  trackEvent() called
         â†“
  POST to /api/analytics
         â†“
  Log to analytics_events table
         â†“
  
  (Separately) Admin Views Stats
         â†“
  GET /api/analytics
         â†“
  Query analytics_events
         â†“
  Aggregate by:
    - Total events
    - Last 7 days
    - Unique users
    - Event types
         â†“
  Display in Admin Dashboard
```

---

## ğŸ’¾ Ø´Ø±Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

### Ø¬Ø¯ÙˆÙ„ `analytics_events`
```sql
id (UUID, Primary Key)
event_type (page_view, prescription_upload, pharmacy_view, ...)
user_id (UUID, Foreign Key â†’ users)
user_role (patient, pharmacy, admin)
page_path (/prescriptions, /pharmacies, ...)
metadata (JSON, Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
created_at (Timestamp)

-- Indexes Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
Index on: (created_at DESC)
Index on: (user_id, event_type)
Index on: (event_type)
```

### Ø¬Ø¯ÙˆÙ„ `push_subscriptions`
```sql
id (UUID, Primary Key)
user_id (UUID, Unique, Foreign Key)
endpoint (URL for push service)
auth_key (Authentication key)
p256dh_key (Encryption key)
is_active (Boolean, true/false)
created_at (Timestamp)
updated_at (Timestamp)

-- RLS Policy: Users can only see their own subscription
-- RLS Policy: Service role can access all for sending
```

---

## ğŸ” Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ø§Ù† (RLS Policies)

### PWA & Analytics:
```typescript
// Service Role (Server) - Full Access âœ…
// Used in: /api routes
// Access: analytics_events, push_subscriptions (All)

// Authenticated Users - Limited Access âœ…
// Used in: Client components
// Access: Only their own data
```

### Database Policies:
```sql
-- analytics_events
-- Policy: "Users can view their own events"
SELECT: uid = auth.uid()

-- push_subscriptions
-- Policy: "Users can view their own subscription"
SELECT: user_id = auth.uid()

-- Policy: "Service role can send notifications"
SELECT: role() = 'service_role'
```

---

## ğŸ“± Ù…Ø³Ø§Ø± PWA Installation

```
User Opens App
         â†“
  [Browser â†’ localhost:3000]
         â†“
  Service Worker Registers
         â†“
  manifest.json Loaded
         â†“
  Install Prompt Appears
         â†“
  User Clicks "Install"
         â†“
  App Added to Home Screen
         â†“
  PWA Cache Downloaded (~100KB)
         â†“
  User Can Open App Offline
```

### Cache Strategy:
```
Network First:
  1. Try to fetch from network
  2. If offline, use cache
  3. For images: Always cache after first load

Critical Files Cached:
  - manifest.json
  - CSS files
  - JavaScript bundles
  - Key images
```

---

## ğŸ”” Ù…Ø³Ø§Ø± Push Notification

### Subscription Phase:
```
User Opens App
         â†“
  Request Notification Permission
         â†“
  User Grants Permission
         â†“
  Generate Push Subscription
         â†“
  Send to /api/notifications/subscribe
         â†“
  Save in Database
         â†“
  âœ… Ready to Receive Notifications
```

### Push Phase:
```
Server Event Triggered
  (e.g., Pharmacy adds prescription)
         â†“
  Get User's Subscription from DB
         â†“
  Create Notification Payload:
    {
      title: "New Prescription",
      body: "Paracetamol - 500mg",
      icon: "icon-192.png",
      url: "/prescriptions/123"
    }
         â†“
  Send via Web Push API
         â†“
  OS Receives Push
         â†“
  Display Notification
         â†“
  Service Worker Handles Click
         â†“
  Open App to Specific URL
```

---

## ğŸ“Š Ù…Ø³Ø§Ø± Analytics

### Event Logging:
```
trackEvent({
  event_type: 'prescription_upload',
  user_id: 'user-123',
  user_role: 'patient',
  page_path: '/upload',
  metadata: {
    file_size: 2048,
    medicine_count: 3
  }
})
         â†“
POST /api/analytics
         â†“
Insert into analytics_events
         â†“
Stored in Database
```

### Stats Query:
```
GET /api/analytics/stats
         â†“
SELECT * FROM analytics_events
  WHERE created_at > NOW() - INTERVAL '7 days'
         â†“
GROUP BY event_type
         â†“
COUNT(*) for total events
COUNT(DISTINCT user_id) for active users
         â†“
Return Statistics
         â†“
Admin Dashboard Displays
```

---

## ğŸŒ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©

### Distance Calculation:
```
Patient Location: (36.7372, 3.0869) - Algiers
Pharmacy 1 Location: (36.7400, 3.0500) - 5.7 km away
Pharmacy 2 Location: (36.5000, 3.5000) - 45 km away

Using Haversine Formula:
  Straight line = calculated distance
  Road distance = Haversine * 1.2 (correction factor)
  
  Pharmacy 1: 5.7 * 1.2 = 6.84 km âœ… Within 50km
  Pharmacy 2: 45 * 1.2 = 54 km âŒ Outside 50km
```

### API Response:
```javascript
GET /api/prescriptions/nearby-pharmacies
  ?userLat=36.7372&userLng=3.0869&prescriptionId=rx-123

Response:
{
  pharmacies: [
    {
      id: "pharmacy-1",
      name: "Pharmacy A",
      address: "...",
      phone: "...",
      latitude: 36.7400,
      longitude: 3.0500,
      distance: 6.84 // km
    },
    ...
  ]
}
```

---

## ğŸ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Metadata

### ÙÙŠ Analytics:
```typescript
trackEvent({
  event_type: 'prescription_upload',
  metadata: {
    file_size: 2048,
    file_type: 'image/png',
    medicine_count: 3,
    upload_duration: 2500 // ms
  }
})

// ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙƒÙ€ JSON ÙÙŠ Database
// ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù†Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
```

### ÙÙŠ Notifications:
```typescript
showNotification({
  title: 'New Prescription',
  body: 'Paracetamol - 500mg',
  tag: 'prescription-123', // Merge similar notifications
  data: {
    url: '/prescriptions/123',
    pharmacy_id: 'pharm-456'
  }
})
```

---

## âš™ï¸ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://...supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=...

# Service Role (Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙ‚Ø·)
SUPABASE_SERVICE_ROLE_KEY=...

# PWA - VAPID Keys
NEXT_PUBLIC_VAPID_PUBLIC_KEY=...
VAPID_PRIVATE_KEY=...

# Optional: Firebase (Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…)
NEXT_PUBLIC_FIREBASE_API_KEY=...
```

---

## ğŸš€ ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø¨Ø¯Ø¡ (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)

```
1. Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„ØªØ´ØºÙŠÙ„
   npm install
   npm run dev

2. Ø§ÙØªØ­ http://localhost:3000

3. Ù‚Ù… Ø¨ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ€ PWA
   (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)

4. Ø§ÙØªØ­ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
   (Browser Ø³ÙŠØ·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†)

5. Ø´Ø§Ù‡Ø¯ Analytics ÙÙŠ Admin
   (Ù‚Ù… Ø¨Ø¹Ù…Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø£ÙˆÙ„Ø§Ù‹)
```

---

## ğŸ” Debugging Tips

### PWA Issues:
```javascript
// ÙÙŠ Console
navigator.serviceWorker.getRegistrations()
  .then(registrations => console.log(registrations))

// ØªØ­Ù‚Ù‚ Ù…Ù† Service Worker
chrome://serviceworker-internals/

// ØªØ­Ù‚Ù‚ Ù…Ù† Manifest
chrome://manifest/
```

### Notifications Issues:
```javascript
// ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø°Ù†
Notification.permission

// Ø§Ø®ØªØ¨Ø± Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠ
new Notification('Test')

// ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
navigator.serviceWorker.controller
  .postMessage({type: 'GET_SUBSCRIPTION'})
```

### Analytics Issues:
```javascript
// ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
// ÙÙŠ Admin Dashboard â†’ Analytics

// Ø£Ùˆ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Supabase Console
SELECT * FROM analytics_events LIMIT 10
```

---

## ğŸ“ˆ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡

### Expected Performance:
- Page Load: < 2 seconds
- PWA Installation: < 5 seconds
- Notification Display: < 1 second
- Analytics Query: < 500ms

### Optimization Tips:
- Image compression for PWA cache
- Lazy load analytics for admin
- Use database indexes for queries
- Implement pagination for large datasets

---

## ğŸ“ Ø§Ù„Ù…Ù„Ø®Øµ

**Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¢Ù† ÙŠØªØ¶Ù…Ù†:**
âœ… User authentication (Supabase)
âœ… Prescription management
âœ… Pharmacy system
âœ… Distance-based filtering (50km)
âœ… PWA support (Offline + Install)
âœ… Push Notifications
âœ… Comprehensive Analytics
âœ… Admin Dashboard with stats

**ÙŠØ¹ØªØ¨Ø± Ø§Ù„Ø¢Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ ÙˆÙ…ØªÙƒØ§Ù…Ù„!** ğŸ‰
